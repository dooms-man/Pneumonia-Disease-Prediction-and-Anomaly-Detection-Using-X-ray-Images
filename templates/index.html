<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pneumonia Detection - DeepLungs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .floating-particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 15s infinite linear;
            pointer-events: none;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        .lung-silhouette {
            position: absolute;
            width: 200px;
            height: 150px;
            opacity: 0.05;
            animation: breathe 6s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(2deg); }
        }

        .lung-left {
            left: 10%;
            top: 20%;
            animation-delay: 0s;
        }

        .lung-right {
            right: 10%;
            bottom: 20%;
            animation-delay: 3s;
        }

        /* Main Container */
        .main-container {
            position: relative;
            z-index: 1;
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 650px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            animation: slideUp 0.8s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }

        .form-content {
            padding: 50px;
        }

        .form-group {
            margin-bottom: 25px;
            animation: fadeIn 0.6s ease-out;
        }

        .form-group:nth-child(1) { animation-delay: 0.1s; }
        .form-group:nth-child(2) { animation-delay: 0.2s; }
        .form-group:nth-child(3) { animation-delay: 0.3s; }
        .form-group:nth-child(4) { animation-delay: 0.4s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        select,
        input[type="file"] {
            width: 100%;
            padding: 16px 20px;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            transition: all 0.3s ease;
            outline: none;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.1);
            transform: translateY(-2px);
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
            cursor: pointer;
        }

        .file-upload input[type="file"] {
            opacity: 0;
            position: absolute;
            z-index: -1;
        }

        .file-upload-label {
            display: block;
            padding: 20px;
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-label:hover {
            border-color: #4facfe;
            background: #eff6ff;
            transform: translateY(-2px);
        }

        .file-upload-text {
            font-size: 16px;
            color: #64748b;
            margin-top: 10px;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 10px;
            background: #4facfe;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .submit-btn {
            width: 100%;
            padding: 18px;
            font-size: 18px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:active {
            transform: translateY(-1px);
        }

        .submit-btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .submit-btn .btn-text {
            position: relative;
            z-index: 1;
        }

        .submit-btn .loading-spinner {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .results {
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 16px;
            border: 1px solid rgba(79, 172, 254, 0.2);
            animation: slideUp 0.6s ease-out;
            display: none;
        }

        .result-item {
            margin-bottom: 25px;
        }

        .result-label {
            font-size: 20px;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 15px;
        }

        .prediction-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 16px;
        }

        .prediction-normal {
            background: #dcfce7;
            color: #166534;
        }

        .prediction-pneumonia {
            background: #fef2f2;
            color: #dc2626;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 4px;
            transition: width 1s ease-out;
        }

        .image-results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .image-container {
            text-align: center;
        }

        .image-container h4 {
            color: #374151;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
        }

        .result-image {
            width: 100%;
            max-width: 250px;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }

        .result-image:hover {
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 20px 10px;
            }
            
            .form-content {
                padding: 30px 25px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .image-results {
                grid-template-columns: 1fr;
            }
        }
                
          #loadingOverlay 
          {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: 'Orbitron', sans-serif;
          }

          .scanner-container 
          {
            text-align: center;
            color: #00ffcc;
          }

          .scanner-frame 
          {
            position: relative;
            width: 300px;
            height: 200px;
            border: 2px solid #00ffcc;
            box-shadow: 0 0 20px #00ffcc;
            overflow: hidden;
            margin-bottom: 20px;
          }

          .scan-line 
          {
            position: absolute;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, #00ffcc, #00ffff);
            animation: scan 1.5s linear infinite;
          }

          @keyframes scan 
          {
            0% { top: 0; }
            100% { top: 100%; }
          }

          .loading-title 
          {
            font-size: 1.5rem;
            color: #00ffcc;
            letter-spacing: 2px;
            margin-bottom: 8px;
          }

          .loading-subtext 
          {
            font-size: 1rem;
            color: #00ffff;
            opacity: 0.8;
          }
          /* Ghost X-ray image styling in overlay */
          #ghostXray 
          {
              position: absolute;
              top: 50%;
              left: 50%;
              width: 180px;
              height: auto;
              transform: translate(-50%, -50%);
              opacity: 0.07;
              filter: grayscale(100%) contrast(150%);
              animation: fadeInOut 4s infinite alternate;
          }

          /* Optional subtle pulsing */
          @keyframes fadeInOut 
          {
              0% { opacity: 0.07; transform: translate(-50%, -50%) scale(1); }
              100% { opacity: 0.12; transform: translate(-50%, -50%) scale(1.05); }
          }

    </style>
</head>
<body>
    <div class="bg-animation" id="bgAnimation">
        <!-- Lung silhouettes -->
        <div class="lung-silhouette lung-left">
            <svg viewBox="0 0 200 150" fill="currentColor" style="color: rgba(255,255,255,0.1);">
                <path d="M50 30c-20 0-35 15-35 35v30c0 20 15 35 35 35h30c15 0 25-10 25-25V55c0-15-10-25-25-25H50z"/>
                <path d="M120 40c-15 0-25 10-25 25v40c0 15 10 25 25 25h25c20 0 35-15 35-35V65c0-20-15-35-35-35h-25z"/>
            </svg>
        </div>
        <div class="lung-silhouette lung-right">
            <svg viewBox="0 0 200 150" fill="currentColor" style="color: rgba(255,255,255,0.1);">
                <path d="M50 30c-20 0-35 15-35 35v30c0 20 15 35 35 35h30c15 0 25-10 25-25V55c0-15-10-25-25-25H50z"/>
                <path d="M120 40c-15 0-25 10-25 25v40c0 15 10 25 25 25h25c20 0 35-15 35-35V65c0-20-15-35-35-35h-25z"/>
            </svg>
        </div>
    </div>

    <div class="main-container">
        <div class="container">
            <div class="header">
                <h1>ü´Å DeepLungs</h1>
                <p>Advanced AI-Powered Pneumonia Detection</p>
            </div>

            <div class="form-content">
                <form id="uploadForm">
                    <div class="form-group">
                        <label class="form-label" for="name">Full Name</label>
                        <input type="text" id="name" name="name" placeholder="Enter your full name" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="age">Age</label>
                        <input type="number" id="age" name="age" placeholder="Enter your age" required min="0" max="120">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="gender">Gender</label>
                        <select id="gender" name="gender" required>
                            <option value="" disabled selected>Select your gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Chest X-Ray Image</label>
                        <div class="file-upload">
                            <input type="file" id="image" name="image" accept="image/*" required>
                            <label for="image" class="file-upload-label">
                                <div class="upload-icon">üì∏</div>
                                <div class="file-upload-text">
                                    Click to upload your chest X-ray image
                                    <br><small>Supported formats: JPG, PNG, GIF</small>
                                </div>
                            </label>
                        </div>
                    </div>

                    <button class="submit-btn" type="submit">
                        <span class="btn-text">üîç Start AI Diagnosis</span>
                        <div class="loading-spinner"></div>
                    </button>
                </form>

                <div class="results" id="results">
                    <div class="result-item">
                        <div class="result-label">üéØ Diagnosis Result</div>
                        <div id="prediction"></div>
                    </div>

                    <div class="result-item">
                        <div class="result-label">üìä Confidence Level</div>
                        <div id="confidence"></div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" id="confidenceFill"></div>
                        </div>
                    </div>

                    <div class="image-results">
                        <div class="result-item" id="healthAdviceSection" style="display:none;">
                            <div class="result-label">üí° AI Health Guidance</div>
                            <p id="healthGuidance" style="white-space: pre-line; color:#374151; font-size: 0.95rem;"></p>
                        </div>

                        <div class="result-item" id="heatmapExplanationSection" style="display:none;">
                            <div class="result-label">üß† Heatmap Interpretation</div>
                            <p id="heatmapExplanation" style="white-space: pre-line; color:#374151; font-size: 0.95rem;"></p>
                        </div>

                        <div class="image-container">
                            <h4>üî• Grad-CAM Heatmap</h4>
                            <img id="gradcamImage" class="result-image" src="" alt="Grad-CAM Analysis">
                        </div>

                        <div class="image-container">
                            <h4>üëÅÔ∏è ViT Attention Map</h4>
                            <img id="attentionImage" class="result-image" src="" alt="Vision Transformer Attention">
                        </div>

                         <!-- New Button -->    
                        <button onclick="showNearbyDoctors()" 
                                style="margin-top: 15px; padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ü©∫ Find Nearby Doctors
                        </button>
                    </div>

                    <!-- Map section hidden until button click -->
                    <div id="mapSection" style="width: 100%; height: 400px; display: none; margin-top: 20px;"></div>

                    <div id="airQualitySection" style="margin-top: 20px; padding: 15px; border-radius: 8px; background: #f0f9ff;">
                        <h4>üå¨ Local Air Quality</h4>
                        <p id="aqiStatus">Loading air quality data...</p>
                    </div>


                        <div class="result-item" id="reportSection" style="display:none; margin-top:20px;">
                        <button id="downloadReportBtn" class="submit-btn" style="background:linear-gradient(135deg,#22c55e,#16a34a);">
                        üìÑ Download PDF Report
                        </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Create floating particles
        function createFloatingParticles() {
            const bgAnimation = document.getElementById('bgAnimation');
            
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'floating-particle';
                
                const size = Math.random() * 10 + 5;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                
                bgAnimation.appendChild(particle);
            }
        }
        

        // Initialize particles
        createFloatingParticles();

        // Form handling
        const form = document.getElementById('uploadForm');
        const submitBtn = form.querySelector('.submit-btn');
        const btnText = submitBtn.querySelector('.btn-text');
        const loadingSpinner = submitBtn.querySelector('.loading-spinner');
        const predictionDiv = document.getElementById('prediction');
        const confidenceDiv = document.getElementById('confidence');
        const confidenceFill = document.getElementById('confidenceFill');
        const gradcamImage = document.getElementById('gradcamImage');
        const attentionImage = document.getElementById('attentionImage');
        const resultsDiv = document.getElementById('results');

        // File upload visual feedback
        const fileInput = document.getElementById('image');
        const fileLabel = document.querySelector('.file-upload-label');
        
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const fileName = e.target.files[0].name;
                fileLabel.innerHTML = `
                    <div class="upload-icon">‚úÖ</div>
                    <div class="file-upload-text">
                        Selected: ${fileName}
                        <br><small>Click to choose a different file</small>
                    </div>
                `;
                fileLabel.style.borderColor = '#10b981';
                fileLabel.style.background = '#f0fdf4';
            }
        });

       form.addEventListener('submit', async (e) => 
       {
          e.preventDefault();

          // Show loading overlay (sci-fi scanner)
          const overlay = document.getElementById('loadingOverlay');
          if (overlay) overlay.style.display = 'flex';

          // Show button spinner (optional)
          submitBtn.classList.add('loading');
          btnText.style.opacity = '0';
          loadingSpinner.style.display = 'block';

          const formData = new FormData(form);

          try {
              const response = await fetch('/predict',
              {
                  method: 'POST',
                  body: formData
              });

              const data = await response.json();

              if (data.error) 
              {
                  alert("‚ùå Error: " + data.error);
                  return;
              }

              const isPneumonia = data.label.toLowerCase().includes('pneumonia');
              const confidence = parseFloat(data.confidence.replace('%', ''));

              predictionDiv.innerHTML = `
                  <span class="prediction-badge ${isPneumonia ? 'prediction-pneumonia' : 'prediction-normal'}">
                      ${isPneumonia ? '‚ö†Ô∏è' : '‚úÖ'} ${data.label}
                  </span>
              `;

              confidenceDiv.innerHTML = `<strong>${data.confidence}</strong>`;

              // Animate confidence bar
              setTimeout(() => 
              {
                  confidenceFill.style.width = confidence + '%';
              }, 100);
              

              gradcamImage.src = data.gradcam_url + '?t=' + new Date().getTime();
              attentionImage.src = data.attention_url + '?t=' + new Date().getTime();
              
              // Show AI health guidance
              if (data.health_guidance) 
              {
                    document.getElementById('healthGuidance').innerText = data.health_guidance;
                    document.getElementById('healthAdviceSection').style.display = 'block';
              }

                // Show Heatmap explanation
              if (data.heatmap_explanation) 
              {
                    document.getElementById('heatmapExplanation').innerText = data.heatmap_explanation;
                    document.getElementById('heatmapExplanationSection').style.display = 'block';
              }


              resultsDiv.style.display = 'block';
              resultsDiv.scrollIntoView({ behavior: 'smooth' });

          } catch (error) 
          {
              alert("‚ùå Prediction failed. Please try again.");
              console.error("Prediction Error:", error);
          } finally 
          {
              // Hide sci-fi overlay
              if (overlay) overlay.style.display = 'none';

              // Reset button spinner
              submitBtn.classList.remove('loading');
              btnText.style.opacity = '1';
              loadingSpinner.style.display = 'none';
          }
      });
        // Add some interactive elements
        document.addEventListener('mousemove', (e) => {
            const lungs = document.querySelectorAll('.lung-silhouette');
            lungs.forEach((lung, index) => {
                const rect = lung.getBoundingClientRect();
                const x = e.clientX - rect.left - rect.width / 2;
                const y = e.clientY - rect.top - rect.height / 2;
                const distance = Math.sqrt(x * x + y * y);
                const maxDistance = 300;
                
                if (distance < maxDistance) {
                    const intensity = (maxDistance - distance) / maxDistance;
                    lung.style.opacity = 0.05 + (intensity * 0.05);
                }
            });
        });

   
        // Show download report button
        document.getElementById('reportSection').style.display = 'block';

        document.getElementById('downloadReportBtn').onclick = () => {
            window.location.href = '/download_report';
};

  function initMap(lat, lng, results) {
    const map = new google.maps.Map(document.getElementById("mapSection"), {
        center: { lat: lat, lng: lng },
        zoom: 14
    });

    // Marker for user's location
    new google.maps.Marker({
        position: { lat: lat, lng: lng },
        map: map,
        title: "Your Location",
        icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
    });

    // Markers for doctors (works for both Google & OSM fallback)
    results.forEach(place => {
        const location = place.geometry?.location || { lat: place.lat, lng: place.lng };

        new google.maps.Marker({
            position: { lat: location.lat, lng: location.lng },
            map: map,
            title: place.name || "Doctor",
            icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
        });
    });
}

    function showNearbyDoctors() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                fetch(`/nearby_doctors?lat=${lat}&lon=${lng}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.results && data.results.length > 0) {
                            document.getElementById("mapSection").style.display = "block";
                            initMap(lat, lng, data.results);
                        } else {
                            alert("No nearby doctors found.");
                        }
                    })
                    .catch(err => {
                        console.error("Error fetching nearby doctors:", err);
                        alert("Could not fetch nearby doctors. Please try again later.");
                    });
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

async function fetchAirQuality() {
  if (!navigator.geolocation) {
    console.error("Geolocation not supported.");
    return;
  }

  navigator.geolocation.getCurrentPosition(async (pos) => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    try {
      const res = await fetch(`/air_quality?lat=${lat}&lon=${lon}`);
      const data = await res.json();
      if (data.error) throw new Error(data.error);

      const idx = data.currentConditions?.indexes?.[0]?.value ?? null;
      const pollutant = data.currentConditions?.pollutants?.[0]?.code ?? "N/A";
      const desc = idx
        ? `AQI: ${idx} ‚Äî Pollutant: ${pollutant}`
        : "No data available";

      document.getElementById('aqiStatus').innerText = desc;
    } catch (err) {
      console.error("AQI error:", err);
      document.getElementById('aqiStatus').innerText =
        "Unable to retrieve air quality.";
    }
  });
}

// Call it when page loads
fetchAirQuality();





    </script>
<!-- Sci-Fi Themed Loading Overlay -->
<div id="loadingOverlay">
  <div class="scanner-container">
    <div class="scanner-frame">
      <div class="scan-line"></div>
      <!-- üëª Ghost X-ray inserted here -->
      <img src="static/images/ghost_xray.jpg" alt="Ghost X-ray" id="ghostXray">
    </div>
    <p class="loading-title">Initiating Diagnostic Sequence</p>
    <p class="loading-subtext">Analyzing radiographic input...</p>
  </div>
</div>

<!-- Load Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyArpCL0MD4VvKpISAEuG14JgtOCgPpZHKE&libraries=places&loading=async" async></script>
</body>
</html>